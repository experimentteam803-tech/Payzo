<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoinMine - Professional Mining Hub</title>
<!-- Telegram SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins', sans-serif}
body{ background: radial-gradient(circle at center, #10141d 0%, #050505 100%); color:white; min-height:100vh; display:flex; flex-direction:column; align-items:center; overflow-x: hidden; }

/* Header */
header{
  display:flex; justify-content:space-between; align-items:center; width:100%; padding:15px 20px;
  background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(50, 205, 50, 0.2);
  position:fixed; top:0; z-index:100;
}
.header-right { display: flex; gap: 15px; align-items: center; }
.gift-trigger { cursor: pointer; font-size: 20px; animation: bounce 2s infinite; }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

header .profile{display:flex;align-items:center;gap:10px}
header .profile img{width:38px;height:38px;border-radius:50%;border:2px solid #32cd32;}
header .profile span{font-weight:600;color:#90ee90;font-size: 13px;}

/* Main */
main{flex:1; width:100%; max-width: 500px; padding-top:80px; padding-bottom: 90px;}
.section{display:none; width:100%; padding:20px; animation:fadeIn 0.4s ease;}
#home{display:block;}

/* Home */
.balance-card { background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 25px 20px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.05); margin-bottom: 25px; }
.balance-card h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 3px; color: #888; margin-bottom: 8px; }
#totalCoins { font-family: 'Orbitron', sans-serif; font-size: 42px; color: #ffd700; font-weight: 700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }

.mining-visualizer { position: relative; width: 260px; height: 260px; margin: 20px auto; display: flex; align-items: center; justify-content: center; }
.outer-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px dashed rgba(50, 205, 50, 0.1); }
.mining-active-glow .outer-ring { border: 2px dashed #32cd32; animation: rotateRing 12s linear infinite; }
.inner-core { width: 180px; height: 180px; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid rgba(255, 255, 255, 0.05); }
.mining-active-glow .inner-core { border-color: #32cd32; box-shadow: 0 0 50px rgba(50, 205, 50, 0.3); animation: pulseCore 2s infinite alternate; }

/* Mining Animation */
#miningEmoji { font-size: 40px; margin-bottom: 5px; transition: 0.3s; }
.mining-active-glow #miningEmoji { animation: pickaxeSwing 1s infinite; }
@keyframes pickaxeSwing {
    0% { transform: rotate(0deg); }
    50% { transform: rotate(-45deg); }
    100% { transform: rotate(0deg); }
}

/* Promotion */
.promo-card { background: rgba(50, 205, 50, 0.05); border: 1px solid #32cd3244; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
.submission-form { background: #161616; padding: 20px; border-radius: 15px; border: 1px solid #333; }
.submission-form input, .submission-form select { width: 100%; padding: 12px; margin: 10px 0 20px; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; }

/* Wallet Expansion */
.method-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
.method-btn { background: #222; border: 1px solid #444; color: #fff; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }
.method-btn.active { background: #32cd32; color: #000; border-color: #32cd32; }

/* Referral Enhanced */
.ref-info-card { background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
.ref-step { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-start; }
.step-num { background: #ffd700; color: #000; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 12px; }

/* Modal Styles */
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; align-items:center; justify-content:center; }
.modal-content { background:#161616; padding:25px; border-radius:20px; width:90%; max-width:400px; border: 1px solid #333; }

/* Buttons & Nav */
.action-btn { width: 100%; padding:15px; border-radius:12px; font-weight:700; cursor:pointer; border: none; font-family: 'Orbitron', sans-serif; text-transform: uppercase; transition: 0.3s; }
.mine-btn { background: #32cd32; color: #000; box-shadow: 0 4px 15px rgba(50, 205, 50, 0.2); }
.mine-btn:disabled { background: #222; color: #555; box-shadow: none; cursor: not-allowed; }
.ad-btn { background: #ffd700; color: #000; margin-bottom: 15px; }
.ad-btn:disabled { background: #444; color: #777; }
.navbar{display:flex;justify-content:space-around;background:rgba(0,0,0,0.95);padding:15px 0;border-top:1px solid #32cd32;position:fixed;bottom:0;width:100%;z-index:100;}
.nav-btn{background:none;border:none;color:white;font-size:18px;cursor:pointer;opacity: 0.5;}
.nav-btn.active{opacity: 1; color: #32cd32;}

@keyframes rotateRing { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes pulseCore { 0% { transform: scale(1); } 100% { transform: scale(1.03); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<header>
    <div class="profile" onclick="showProfile()">
        <img id="profile-img" src="https://i.pravatar.cc/45" alt="Profile">
        <span id="username">Loading...</span>
    </div>
    <div class="header-right">
        <div class="gift-trigger" onclick="openGiftModal()">üéÅ</div>
        <div class="msg-icon" onclick="showMsg()">‚ö°</div>
    </div>
</header>

<main>
    <!-- HOME -->
    <section id="home" class="section">
        <div class="balance-card">
            <h2>Net Balance</h2>
            <div id="totalCoins">0</div>
        </div>
        <div class="mining-visualizer" id="mineCircle">
            <div class="outer-ring"></div>
            <div class="inner-core">
                <div id="miningEmoji">‚õèÔ∏è</div>
                <span id="coinInsideCircle">0</span>
            </div>
        </div>
        <button class="action-btn ad-btn" id="watchAdBtn" onclick="watchAd()">üé¨ Watch Ad (+Progress)</button>
        <div id="adStatus" style="text-align:center; color:#ffd700; margin-bottom:15px; font-size:12px;">Ads Required to Mine: 0/10</div>
        <button class="action-btn mine-btn" id="mineBtn" onclick="startDailyMining()">ü™ô Start Mining</button>
        <div id="miningCountdown" style="text-align:center; color:#90ee90; font-size:12px; margin-top:10px;">Ready</div>
    </section>

    <!-- PROMOTION -->
    <section id="promotion" class="section">
        <div style="text-align:center; margin-bottom:20px;">
            <h2 style="font-family:'Orbitron'; color:#32cd32;">Creator Rewards</h2>
            <p style="color:#aaa; font-size:12px;">Make a video & get up to 50,000 Coins!</p>
        </div>
        <div class="promo-card">
            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:10px;">
                <span>YouTube Long (100+ views)</span> <b>50k Max</b>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:13px;">
                <span>Shorts/Reels (1k+ views)</span> <b>50k Max</b>
            </div>
        </div>
        <div class="submission-form">
            <label style="font-size:12px; color:#aaa;">Platform</label>
            <select id="promoPlatform"><option>YouTube</option><option>Instagram</option><option>Facebook</option></select>
            <label style="font-size:12px; color:#aaa;">Content Type</label>
            <select id="promoType"><option>Long Video</option><option>Shorts/Reels</option></select>
            <input type="url" id="promoLink" placeholder="Paste your video link here">
            <button class="action-btn mine-btn" onclick="submitPromotion()">Submit for Review</button>
        </div>
    </section>

    <!-- WALLET -->
    <section id="wallet" class="section">
        <h2 style="text-align:center; font-family:'Orbitron'; margin-bottom:25px;">Wallet</h2>
        <div class="balance-card">
            <div style="font-size:32px; color:#ffd700; font-family:'Orbitron';" id="walletCoins">0</div>
            <div style="color:#90ee90;">‚âà ‚Çπ <span id="walletValue">0.00</span></div>
        </div>
        <div class="submission-form">
            <h4 style="margin-bottom:15px; font-size:14px;">Withdraw Funds</h4>
            <div class="method-tabs">
                <button class="method-btn active" onclick="setMethod('upi', this)">UPI (India)</button>
                <button class="method-btn" onclick="setMethod('paypal', this)">PayPal</button>
                <button class="method-btn" onclick="setMethod('crypto', this)">Crypto (USDT)</button>
            </div>
            <input type="number" id="withdrawAmount" placeholder="Enter Coins (Min 10,000)">
            <input type="text" id="withdrawAddress" placeholder="UPI ID / Email / Wallet Address">
            <button class="action-btn mine-btn" onclick="handleWithdrawal()">Request Withdrawal</button>
        </div>
    </section>

    <!-- REFERRAL -->
    <section id="referral" class="section">
        <h2 style="text-align:center; font-family:'Orbitron'; margin-bottom:20px;">Refer & Earn</h2>
        <div class="ref-info-card">
            <div class="ref-step">
                <div class="step-num">1</div>
                <div><b style="color:#ffd700;">Share:</b> Send your unique link to friends.</div>
            </div>
            <div class="ref-step">
                <div class="step-num">2</div>
                <div><b style="color:#ffd700;">700 Coins:</b> Get instantly when they signup.</div>
            </div>
            <div class="ref-step">
                <div class="step-num">3</div>
                <div><b style="color:#ffd700;">5% Commission:</b> Get lifetime reward from their mining!</div>
            </div>
        </div>
        <div class="submission-form" style="text-align:center;">
            <p id="refLink" style="font-size:11px; color:#ffd700; margin-bottom:15px; word-break:break-all;">Loading...</p>
            <button class="action-btn ad-btn" onclick="shareReferralLink()">üì¢ Invite Friends Now</button>
        </div>
    </section>
</main>

<nav class="navbar">
    <button class="nav-btn active" onclick="showSection('home', this)">üè†</button>
    <button class="nav-btn" onclick="showSection('promotion', this)">üöÄ</button>
    <button class="nav-btn" onclick="showSection('wallet', this)">üíº</button>
    <button class="nav-btn" onclick="showSection('referral', this)">üîó</button>
</nav>

<!-- GIFT MODAL -->
<div id="giftModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="font-family:'Orbitron'; color:#ffd700; text-align:center; margin-bottom:15px;">üéÅ Redeem Gift</h3>
        <input type="text" id="giftCode" placeholder="Enter Gift Code" style="width:100%; padding:12px; background:#000; border:1px solid #444; color:#fff; border-radius:10px; text-align:center; margin-bottom:15px;">
        <button class="action-btn mine-btn" onclick="redeemGift()" style="margin-bottom:20px;">Redeem Now</button>
        <button onclick="closeGiftModal()" style="width:100%; background:transparent; border:none; color:#777; margin-top:15px; font-size:12px;">Close</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue, update, push, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

// Telegram SDK Initialization
const tg = window.Telegram.WebApp;
tg.expand(); // Full screen mode
const tgUser = tg.initDataUnsafe?.user;

// Get Telegram ID and Name
const TELEGRAM_USER_ID = tgUser?.id ? tgUser.id.toString() : "GUEST_USER";
const TELEGRAM_USER_NAME = tgUser?.first_name || "Miner";

const firebaseConfig = {
  apiKey: "AIzaSyC1I28Wki29kWzAgHh_SJ6GERzjoMIsrMI",
  authDomain: "telegram-mini-bot-c5449.firebaseapp.com",
  projectId: "telegram-mini-bot-c5449",
  storageBucket: "telegram-mini-bot-c5449.firebasestorage.app",
  messagingSenderId: "28692089044",
  appId: "1:28692089044:web:49eaa714292a83c4fe1341",
  measurementId: "G-TRBS9XJ78S"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const analytics = getAnalytics(app);

const userPath = 'users/' + TELEGRAM_USER_ID;
const dbRef = ref(database, userPath);

window.coins = 0;
window.adsWatched = 0;
window.miningStartTime = 0;
window.miningEndTime = 0;
window.isMiningActive = false;

// Load Data
function loadUserData() {
    onValue(dbRef, (snap) => {
        const data = snap.val();
        if(data) {
            window.coins = data.coins || 0;
            window.adsWatched = data.adsWatched || 0;
            window.miningStartTime = data.miningStartTime || 0;
            window.miningEndTime = data.miningEndTime || 0;
            document.getElementById('username').innerText = data.userName || TELEGRAM_USER_NAME;
            document.getElementById('refLink').innerText = `https://t.me/YourBot?start=${TELEGRAM_USER_ID}`;
            
            checkMiningStatus();
        } else {
            // New user registration using Telegram Name
            set(dbRef, { 
                coins: 0, 
                userName: TELEGRAM_USER_NAME, 
                adsWatched: 0, 
                miningStartTime: 0, 
                miningEndTime: 0 
            });
        }
    });
}

function checkMiningStatus() {
    const now = Date.now();
    if (window.miningEndTime > now) {
        window.isMiningActive = true;
        updateMiningUI(true);
        startLiveCounter();
    } else {
        if (window.isMiningActive) {
            finalizeMiningSession();
        } else if (window.miningEndTime !== 0 && window.miningEndTime <= now) {
            finalizeMiningSession();
        } else {
            updateMiningUI(false);
        }
    }
}

function finalizeMiningSession() {
    window.isMiningActive = false;
    const finalReward = 1000;
    const newTotal = window.coins + finalReward;
    
    update(dbRef, { 
        coins: newTotal, 
        miningStartTime: 0, 
        miningEndTime: 0,
        adsWatched: 0 
    });
    alert("Mining Session Complete! 1,000 Coins added to balance.");
}

function updateMiningUI(isActive) {
    const mineBtn = document.getElementById('mineBtn');
    const watchBtn = document.getElementById('watchAdBtn');
    const circle = document.getElementById('mineCircle');
    const countdown = document.getElementById('miningCountdown');
    const adStatus = document.getElementById('adStatus');

    if (isActive) {
        circle.classList.add('mining-active-glow');
        mineBtn.disabled = true;
        mineBtn.innerText = "‚õèÔ∏è Mining Active...";
        watchBtn.disabled = true;
        adStatus.innerText = "Mining in progress...";
    } else {
        circle.classList.remove('mining-active-glow');
        mineBtn.disabled = (window.adsWatched < 10);
        mineBtn.innerText = window.adsWatched < 10 ? "üîí Lock (Watch Ads)" : "ü™ô Start Mining";
        watchBtn.disabled = false;
        adStatus.innerText = `Ads Required to Mine: ${window.adsWatched}/10`;
        countdown.innerText = "Ready to Mine";
        updateCoinDisplays(window.coins);
    }
}

function startLiveCounter() {
    if (!window.isMiningActive) return;
    
    const interval = setInterval(() => {
        const now = Date.now();
        if (now >= window.miningEndTime) {
            clearInterval(interval);
            checkMiningStatus();
            return;
        }

        const totalDuration = 3600000; 
        const elapsed = now - window.miningStartTime;
        const earnedNow = Math.floor((elapsed / totalDuration) * 1000);
        
        updateCoinDisplays(window.coins + earnedNow);
        
        const remaining = Math.round((window.miningEndTime - now) / 1000);
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        document.getElementById('miningCountdown').innerText = `Ends in: ${mins}m ${secs}s`;

    }, 1000);
}

function updateCoinDisplays(displayValue) {
    const formatted = Math.floor(displayValue).toLocaleString();
    document.getElementById('totalCoins').innerText = formatted;
    document.getElementById('coinInsideCircle').innerText = formatted;
    document.getElementById('walletCoins').innerText = formatted;
    document.getElementById('walletValue').innerText = (displayValue / 1000).toFixed(2);
}

window.watchAd = () => {
    if(window.adsWatched >= 10 || window.isMiningActive) return;
    const btn = document.getElementById('watchAdBtn');
    btn.disabled = true; btn.innerText = "üé¨ Playing...";
    
    setTimeout(() => {
        window.adsWatched++;
        update(dbRef, { adsWatched: window.adsWatched });
        btn.disabled = false; btn.innerText = "üé¨ Watch Ad (+Progress)";
    }, 2500);
};

window.startDailyMining = () => {
    if(window.adsWatched < 10) { alert("Please watch 10 ads first!"); return; }
    const startTime = Date.now();
    const endTime = startTime + 3600000; 
    update(dbRef, { miningStartTime: startTime, miningEndTime: endTime });
};

window.setMethod = (method, btn) => {
    document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const placeholderMap = { upi: 'UPI ID (example@upi)', paypal: 'PayPal Email', crypto: 'USDT TRC20 Address' };
    document.getElementById('withdrawAddress').placeholder = placeholderMap[method];
};

window.handleWithdrawal = () => {
    const amt = Number(document.getElementById('withdrawAmount').value);
    const addr = document.getElementById('withdrawAddress').value.trim();
    if(amt < 10000 || amt > window.coins) { alert("Invalid Amount (Min 10,000)"); return; }
    if(addr.length < 5) { alert("Invalid Address!"); return; }
    push(ref(database, 'withdrawals'), { userId: TELEGRAM_USER_ID, amount: amt, address: addr, status: 'Pending', timestamp: Date.now() });
    update(dbRef, { coins: window.coins - amt });
    alert("Withdrawal Requested!");
};

window.submitPromotion = () => {
    const link = document.getElementById('promoLink').value.trim();
    if(!link.includes('http')) { alert("Enter valid link!"); return; }
    push(ref(database, 'promotion_submissions'), { userId: TELEGRAM_USER_ID, link: link, status: 'Pending', timestamp: Date.now() });
    alert("Video submitted!");
};

window.openGiftModal = () => document.getElementById('giftModal').style.display = 'flex';
window.closeGiftModal = () => document.getElementById('giftModal').style.display = 'none';

window.redeemGift = async () => {
    const code = document.getElementById('giftCode').value.trim().toUpperCase();
    const snap = await get(ref(database, 'claim_settings/common'));
    if(snap.val() && snap.val().code === code) {
        update(dbRef, { coins: window.coins + snap.val().coins });
        alert("Gift Redeemed!"); closeGiftModal();
    } else { alert("Invalid Code!"); }
};

window.showSection = (id, btn) => {
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
};

window.shareReferralLink = () => {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(document.getElementById('refLink').innerText)}&text=Join CoinMine!`);
};

loadUserData();
window.showProfile = () => alert("Telegram Name: " + TELEGRAM_USER_NAME + "\nUser ID: " + TELEGRAM_USER_ID);
window.showMsg = () => alert("Keep Mining!");
</script>
</body>
</html>
